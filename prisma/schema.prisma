generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    String @id @default(cuid())
  email                 String @unique
  password              String
  name                  String?
  role                  Role @default(CUSTOMER)
  referenceCode         String @unique
  referredById          String?
  referredBy            User? @relation("Referrals", fields: [referredById], references: [id])
  referrals             User[] @relation("Referrals")
  pointsBalance         Int @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  profilePhoto          String?
  pointTransactions     PointTransaction[]
  ownedCoupons         Coupon[] @relation("CouponOwner")
  coupons              Coupon[] @relation("CouponUser")
  events                Event[] @relation("OwnerEvents")
  tickets               Ticket[]
  transactions          Transaction[]
}

model PointTransaction {
  id                    String @id @default(cuid())
  user                  User @relation(fields: [userId], references: [id])
  userId                String
  points                Int
  type                  PointTxnType
  expiresAt             DateTime
  createdAt             DateTime @default(now())
}

model Coupon {
  id                    String @id @default(cuid())
  code                  String @unique
  discount              Int
  ownerId               String?
  owner                 User? @relation("CouponOwner", fields: [ownerId], references: [id])
  userId                String?
  user                  User? @relation("CouponUser", fields: [userId], references: [id])
  expiresAt             DateTime
  createdAt             DateTime @default(now())
  used                  Boolean @default(false)
  transactions          Transaction[] @relation("CouponTransactions")
}

model Event {
  id                    String @id @default(cuid())
  title                 String
  description           String?
  ownerId               String
  owner                 User @relation("OwnerEvents", fields: [ownerId], references: [id])
  capacity              Int
  seatsLeft             Int
  price                 Int
  startAt               DateTime
  endAt                 DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  tickets               Ticket[]
  transactions          Transaction[] @relation("EventTransactions")
}

model Ticket {
  id                    String @id @default(cuid())
  event                 Event @relation(fields: [eventId], references: [id])
  eventId               String
  userId                String
  user                  User @relation(fields: [userId], references: [id])
  quantity              Int
  totalPrice            Int
  createdAt             DateTime @default(now())
}

model Transaction {
  id                    String @id @default(cuid())
  user                  User @relation(fields: [userId], references: [id])
  userId                String
  eventId               String
  event                 Event @relation("EventTransactions", fields: [eventId], references: [id])
  amount                Int
  status                TxStatus @default(PENDING)
  proofUrl              String?
  couponId              String?
  coupon                Coupon? @relation("CouponTransactions", fields: [couponId], references: [id])
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

enum Role {
  CUSTOMER
  ORGANIZER
}


enum PointTxnType {
  EARN
  SPEND
  EXPIRE
}


enum TxStatus {
  PENDING
  ACCEPTED
  REJECTED
}